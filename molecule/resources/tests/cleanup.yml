---
- name: Cleanup
  hosts: localhost
  tasks:
    - name: Get status of pipeline
      uri:
        url: https://gitlab.com/api/v4/projects/15447129/runners?tag_list=molecule_test
        headers:
          PRIVATE-TOKEN: >-
            {{ lookup('env', 'gitlab_api_token') }}
        method: GET
      register: runners
      # until: '"success" in status_of_pipeline.json.status'
      # retries: 5
      # delay: 5

    - name: debug runners
      debug:
        var: runners

    - name: Remove gitlab-runner
      gitlab_runner:
        api_url: https://gitlab.com
        api_token: >-
          {{ lookup('env', 'gitlab_api_token') }}
        description: '{{ item.description }}'
        state: absent
      become: true
      loop: '{{ runners.json }}'
