---
- name: Set advanced configuration | global section values
  lineinfile:
    dest: /etc/gitlab-runner/config.toml
    regexp: '^(.*){{ item.key }} ='
    line: '\1{{ item.key }} = {{ item.value }}'
    state: present
    backrefs: true
  notify: restart gitlab-runner
  loop: "{{ gitlab_runner_config.global_values | default({}) | dict2items }}"
  become: true
  tags:
    - always

- name: Set advanced configuration | global section strings
  lineinfile:
    dest: /etc/gitlab-runner/config.toml
    line: '{{ item.key }} = "{{ item.value }}"'
    state: present
  notify: restart gitlab-runner
  loop: "{{ gitlab_runner_config.global_strings | default({}) | dict2items }}"
  become: true
  tags:
    - always

- name: Force all notified handlers to run
  meta: flush_handlers
  tags:
    - always

- name: List all configured runners
  command: gitlab-runner list
  register: configured_runners
  failed_when: configured_runners.rc != 0
  changed_when: false
  tags:
    - always

- name: register gitlab-runner
  gitlab_runner:
    url: "https://git.epam.com/"
    api_token: "Dps7cqnWihUNzy_kswMe"
    registration_token: '{{ gitlab_ci_token }}'
    description: '{{ gitlab_runner_description }}'
    tag_list: '{{ gitlab_runner_tags }}'
    run_untagged: '{{ gitlab_runner_untagged_builds_run }}'
    state: present
  register: runner_registered
  become: true
  #failed_when: runner_registered.rc != 0
  when:
    - gitlab_ci_token | length
  #environment: '{{ gitlab_runner_config.params }}'
  #no_log: "{{ no_logs | default(true) | bool }}"
  tags:
    - always
